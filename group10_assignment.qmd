---
title: "group10_assignment"
format: html
editor: visual
---

## PCA tidyverse style

#### loading libraries

```{r}
library(tidyverse)
library(broom)  # devtools::install_github("tidymodels/broom")
library(cowplot)
```

#### loading the data

```{r}
biopsy <- read_csv("https://wilkelab.org/classes/SDS348/data_sets/biopsy.csv")

```

```{r}
biopsy
```

Note:

`prcomp()` function can only deal with numeric columns - we need to remove all non-numeric columns from the data. by using `where(is.numeric)`

Want to scale the data values to unit variance before PCA - using the argument `scale = TRUE` in `prcomp()`.

```{r}
pca_fit <- biopsy %>% 
  select(where(is.numeric)) %>% # retain only numeric columns
  prcomp(scale = TRUE) # do PCA on scaled data
```

```{r}
pca_fit 
```

alternative to `scale = TRUE`, we could also have scaled the data by explicitly invoking the `scale()` function.

```{r}
pca_fit <- biopsy %>% 
  select(where(is.numeric)) %>% # retain only numeric columns
  scale() %>% # scale data
  prcomp() # do PCA
```

#### plot the data in PC coordinates

combining the PC coordinates with the original dataset

color points by categorical variables present in the original data but removed for the PCA by `augment()` function from broom, takes as arguments the fitted model and the original data.

The columns containing the fitted coordinates are called `.fittedPC1`, `.fittedPC2`, etc.

```{r}
pca_fit %>%
  augment(biopsy) %>% # add original dataset back in
  ggplot(aes(.fittedPC1, .fittedPC2, color = outcome)) + 
  geom_point(size = 1.5) +
  scale_color_manual(
    values = c(malignant = "#D55E00", benign = "#0072B2")
  ) +
  theme_half_open(12) + background_grid()
```

#### plot the rotation matrix

The rotation matrix is stored as `pca_fit$rotation`

weâ€™ll extract it using the `tidy()` function from broom. When applied to `prcomp` objects, the `tidy()` function takes an additional argument `matrix`, which we set to `matrix = "rotation"` to extract the rotation matrix.

```{r}
# extract rotation matrix
pca_fit %>%
  tidy(matrix = "rotation")
```

##### here we can see the cells we have and the dataframe we have

```{r}
pca_fit %>%
  tidy(matrix = "rotation") %>%
  filter(PC == 1:2) %>%
  pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value")

```

#### Now in the context of a plot:

```{r}
# define arrow style for plotting
arrow_style <- arrow(
  angle = 20, ends = "first", type = "closed", length = grid::unit(8, "pt")
)

# plot rotation matrix
pca_fit %>%
  tidy(matrix = "rotation") %>%
  pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") %>%
  ggplot(aes(PC1, PC2)) +
  geom_segment(xend = 0, yend = 0, arrow = arrow_style) +
  geom_text(
    aes(label = column),
    hjust = 1, nudge_x = -0.02, 
    color = "#904C2F"
  ) +
  xlim(-1.25, .5) + ylim(-.5, 1) +
  coord_fixed() + # fix aspect ratio to 1:1
  theme_minimal_grid(12)

```

we can see the Mitoses is not really related to the others.

#### plot the variance explained by each PC

extract this information using the `tidy()` function from broom, now by setting the `matrix` argument to `matrix = "eigenvalues"`.

```{r}
pca_fit %>%
  tidy(matrix = "eigenvalues")
```

#### Plot

```{r}
pca_fit %>%
  tidy(matrix = "eigenvalues") %>%
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#56B4E9", alpha = 0.8) +
  scale_x_continuous(breaks = 1:9) +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))
  ) +
  theme_minimal_hgrid(12)

```

The first component captures 65% of the variation in the data and, as we can see from the first plot in this post, nicely separates the benign samples from the malignant samples.

So we can see that PC1 is the most important and has the highest %.
